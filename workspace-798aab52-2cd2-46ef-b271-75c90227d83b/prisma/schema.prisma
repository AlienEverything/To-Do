// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  level     Int      @default(1)
  totalXP   Int      @default(0)
  streak    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tasks           Task[]
  studySessions   StudySession[]
  achievements    UserAchievement[]
  pomodoroSessions PomodoroSession[]
  studyGoals      StudyGoal[]
  focusModes      FocusMode[]
  scheduledTasks  ScheduledTask[]

  @@map("users")
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  completed   Boolean   @default(false)
  priority    Priority  @default(MEDIUM)
  xp          Int       @default(10)
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Categories/Tags
  category    String?   @default("general")
  subject     String?

  // Parent-child relationship for subtasks
  parentId    String?
  parent      Task?     @relation("TaskHierarchy", fields: [parentId], references: [id])
  subtasks    Task[]    @relation("TaskHierarchy")

  @@map("tasks")
}

model StudySession {
  id          String   @id @default(cuid())
  subject     String
  duration    Int      // in minutes
  xp          Int      @default(0)
  notes       String?
  createdAt   DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session quality metrics
  focusRating Int?     // 1-5 rating of focus level
  difficulty  Int?     // 1-5 rating of difficulty

  @@map("study_sessions")
}

model PomodoroSession {
  id          String   @id @default(cuid())
  duration    Int      // in minutes
  isBreak     Boolean  @default(false)
  completed   Boolean  @default(false)
  xp          Int      @default(0)
  createdAt   DateTime @default(now())
  completedAt DateTime?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sessionType String   @default("work") // "work", "short_break", "long_break"

  @@map("pomodoro_sessions")
}

model Achievement {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String
  xpReward    Int      @default(0)
  condition   String   // JSON string describing unlock condition
  createdAt   DateTime @default(now())

  // Relations
  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  unlockedAt    DateTime @default(now())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model StudyGoal {
  id          String   @id @default(cuid())
  title       String
  description String?
  targetXP    Int
  targetHours Int
  startDate   DateTime
  endDate     DateTime
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_goals")
}

model FocusMode {
  id          String   @id @default(cuid())
  startTime   DateTime @default(now())
  endTime     DateTime?
  duration    Int?     // in minutes
  blockedApps String?  // JSON array of blocked apps/websites
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("focus_modes")
}

model ScheduledTask {
  id          String   @id @default(cuid())
  title       String
  date        DateTime
  startTime   String
  endTime     String
  priority    Priority @default(MEDIUM)
  category    String?  @default("general")
  subject     String?
  recurring   Boolean  @default(false)
  recurringType String? @default("daily") // "daily", "weekly", "monthly"
  reminder    Boolean  @default(false)
  reminderTime String?  @default("15") // minutes before
  notes       String?
  color       String?  @default("#3b82f6")
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("scheduled_tasks")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}